#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "$0")" && pwd)"
START_SCRIPT="$ROOT_DIR/scripts/start-mcp.sh"
STOP_SCRIPT="$ROOT_DIR/scripts/stop-mcp.sh"
PORT="${MCP_DEBUG_PORT:-9222}"
PROFILE_DIR="${MCP_PROFILE_DIR:-/tmp/chrome-mcp}"
BROWSER_LOG="${MCP_BROWSER_LOG:-/tmp/chrome-mcp-browser.log}"
CODENAME_PATTERN="${CODENAME_PATTERN:-chrome-devtools-mcp}"


usage() {
  cat <<USAGE
word (start|stop|status|reset|ready)
  start        Kill stale processes + launch Chrome
  stop         Kill Chrome + helpers
  status       Show DevTools endpoint
  reset        stop -> start
  ready        stop -> start -> status (one shot)
USAGE
}

require_scripts() {
  if [ ! -x "$START_SCRIPT" ] || [ ! -x "$STOP_SCRIPT" ]; then
    echo "Missing scripts/start-mcp.sh or scripts/stop-mcp.sh" >&2
    exit 1
  fi
}

do_start() {
  require_scripts


  "$START_SCRIPT"
}

do_stop() {
  require_scripts
  "$STOP_SCRIPT"
}

do_status() {
  echo "== Chrome DevTools endpoint =="
  if curl -fs "http://localhost:${PORT}/json/version" >/dev/null 2>&1; then
    echo "OK: http://localhost:${PORT}/json/version"
  else
    echo "UNREACHABLE on port ${PORT}"
  fi
  echo

  pgrep -fl "$CODENAME_PATTERN" 2>/dev/null || echo "(none)"
  echo
  echo "Logs:"
  echo "  Browser -> $BROWSER_LOG"
  echo "  (MCP server is spawned by each client via stdio)"
}


do_reset() {
  do_stop || true
  do_start
}

do_ready() {
  do_reset
  do_status
}

cmd="${1:-help}"
case "$cmd" in
  start|go|on)
    do_start
    ;;
  stop|off)
    do_stop
    ;;
  status)
    do_status
    ;;
  reset|restart)
    do_reset
    ;;
  ready|prep)
    do_ready
    ;;

  *)
    usage
    exit 1
    ;;
esac
